# –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ 7

**–î–µ–ª–∞–ª –ø–æ –ª–µ–∫—Ü–∏–∏. –£—Å—Ç–∞–Ω–æ–≤–∏–ª minikube –∏ Docker –¥–ª—è Win** 
1. –ü—Ä–æ–≤–µ—Ä–∏–ª —Å—Ç–∞—Ç—É—Å minikube
```
D:\PG2\kub2>minikube status
```
–í—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```
type: Control Plane   
host: Running
kubelet: Running      
apiserver: Running    
kubeconfig: Configured
```
2. –î–æ–±–∞–≤–ª—è—é –Ω–æ–≤—ã–π –ü–û–î postgres.yaml
```
D:\PG2\kub2\postgres>kubectl apply -f postgres.yaml
```
```
service/postgres created
statefulset.apps/postgres-statefulset created
```
–°–∞–º —Ñ–∞–π–ª postgres.yaml
```
apiVersion: v1
kind: Service
metadata:
  name: postgres
  labels:
    app: postgres
spec:
  type: NodePort
  ports:
   - port: 5432
  selector:
    app: postgres

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-statefulset
spec:
  serviceName: "postgres"
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: postgres:latest
        ports:
        - containerPort: 5432
          name: postgredb
        env:
          - name: POSTGRES_DB
            value: myapp
          - name: POSTGRES_USER
            value: myuser
          - name: POSTGRES_PASSWORD
            value: passwd
        volumeMounts:
        - name: postgredb
          mountPath: /var/lib/postgresql/data
          subPath: postgres
  volumeClaimTemplates:
  - metadata:
      name: postgredb
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: standard
      resources:
        requests:
          storage: 1Gi
```
–ü–æ –¥–∞–Ω–Ω–æ–º—É –º–∞–Ω–∏—Ñ–µ—Å—Ç—É —è —Å–æ–∑–¥–∞—é Postgre –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏. –ë–î myapp, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å myuser, –ü–∞—Ä–æ–ª—å passwd.
–Ø –º–µ–Ω—è–ª –Ω–∞–∑–≤–∞–Ω–∏—è –ë–î,–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å, –≤–æ–æ–±—â–µ –Ω–æ–ª—å —Ä–µ–∞–∫—Ü–∏–∏. –í—Å–µ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ë–î myapp, –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å myuser, –ü–∞—Ä–æ–ª—å passwd.
–Ø –ø–æ–∫–∞ —Ç–∞–∫ –∏ –Ω–µ –ø–æ–Ω—è–ª –ø–æ—á–µ–º—É
3. –ü—Ä–æ–≤–µ—Ä—è—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ–¥—ã
```
D:\PG2\kub2\postgres>kubectl get pods
NAME                     READY   STATUS
     RESTARTS   AGE
hello-demo               1/1     Running        
     0          87m
postgres-statefulset-0   0/1     ContainerCreating   0          43s
```
–°–º–æ—Ç—Ä—é –≤ –¥–∞—à–±–æ—Ä–¥–µ
```
D:\PG2\kub2\postgres\app>minikube dashboard
ü§î  Verifying dashboard health ...
üöÄ  Launching proxy ...
ü§î  Verifying proxy health ...
üéâ  Opening http://127.0.0.1:64728/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ in your default browser...
```
![2023-06-02_16-25-04](https://github.com/sfedorovceavtru/otus_pg2/assets/122378097/12514e7a-4aee-413b-9308-52065aaa44ac)

4. –ü–µ—Ä–µ–∫–∏–¥—ã–≤–∞—é –ø–æ—Ä—Ç—ã, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø–æ—Å—Ç–≥—Ä–µ
```
D:\PG2\kub2\postgres>minikube service postgres --url -n pg-kub1
http://127.0.0.1:61700
‚ùó  Because you are using a Docker driver on  it.
windows, the terminal needs to be open to run it.
```
5. –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ –ø–æ—Å—Ç–≥—Ä–µ –∏ —Å–º–æ—Ç—Ä—é —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å
```
D:\PG2\kub2>"D:\PostgreSQL\bin\psql.exe" -h 127.0.0.1 -p 61700 -U myuser -W myapp
Password: 
psql (15.2, server 15.3 (Debian 15.3-1.pgdg110+1))
WARNING: Console code page (866) differs from Windows code page (1251)
         8-bit characters might not work correctly. See psql reference
         page "Notes for Windows users" for details.
Type "help" for help.

myapp=# \l
                                             List of databases
   Name    | Owner  | Encoding |  Collate   |   
Ctype    | ICU Locale | Locale Provider | Access privileges
-----------+--------+----------+------------+------------+------------+-----------------+-------------------
 myapp     | myuser | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            |       
 postgres  | myuser | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            |       
 template0 | myuser | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/myuser        +
           |        |          |            |   
         |            |                 | myuser=CTc/myuser
 template1 | myuser | UTF8     | en_US.utf8 | en_US.utf8 |            | libc            | =c/myuser        +
           |        |          |            |   
         |            |                 | myuser=CTc/myuser
(4 rows)
```
–í–∏–∂—É,—á—Ç–æ –ø–æ—Å—Ç–≥—Ä–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ë–î myapp —Å–æ–∑–¥–∞–Ω–∞


**–£—Å—Ç–∞–Ω–æ–≤–ª–∏ —á–µ—Ä–µ–∑ Helm**
1. –ó–∞–ø—É—Å—Ç–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ charts app-prod –∏–∑ –ø–∞–∫–µ—Ç–∞ app.
–í—ã–≤–æ–¥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
```
helm.exe install app-prod app --dry-run
```
```
NAME: app-prod
LAST DEPLOYED: Fri Jun  2 17:18:22 2023
NAMESPACE: pg-kub1
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: app-chart/templates/secrets.yaml      
apiVersion: v1
kind: Secret
metadata:
  name: secret-app-prod-app-chart
type: Opaque
data:
  DATABASE_URI: "cG9zdGdyZXNxbCtwc3ljb3BnMjovL215dXNlcjpwYXNzd2RAcG9zdGdyZXM6NTQzMi9teWFwcA=="  
---
# Source: app-chart/templates/app-config.yaml   
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-app-prod-app-chart
data:
  GREETING: hello from default
---
# Source: app-chart/templates/service.yaml      
apiVersion: v1
kind: Service
metadata:
  name: service-app-prod-app-chart
spec:
  selector:
    app.kubernetes.io/name: app-chart
    app.kubernetes.io/instance: app-prod        
  ports:
    - protocol: TCP
      port: 9000
      targetPort: web
  type: NodePort
---
# Source: app-chart/templates/deployment.yaml   
apiVersion: apps/v1
kind: Deployment
metadata:
    name: deployment-app-prod-app-chart
spec:
    replicas: 2
    selector:
       matchLabels:
            app.kubernetes.io/name: app-chart   
            app.kubernetes.io/instance: app-prod
    template:
       metadata:
          labels:
                app.kubernetes.io/name: app-chart
                app.kubernetes.io/instance: app-prod
       spec:
          containers:
          - name: app-chart
            image: pg_kub1_postgres:v1
            env:
              - name: DATABASE_URI
                valueFrom:
                  secretKeyRef:
                    name: secret-app-prod-app-chart
                    key: DATABASE_URI
              - name: GREETING
                valueFrom:
                  configMapKeyRef:
                    name: config-app-prod-app-chart
                    key: GREETING
            ports:
              - name: web
                containerPort: 80
```
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
```
helm.exe install app-prod app  
```
```
NAME: app-prod
LAST DEPLOYED: Fri Jun  2 17:22:08 2023
NAMESPACE: pg-kub1
STATUS: deployed
REVISION: 1     
TEST SUITE: None
```

–ê –¥–∞–ª—å—à–µ —è –ø–æ–∫–∞ –Ω–µ —É—Å–ø–µ–ª
