# Домашнее задание 4

1. Подключился к виртуальной машине, созданной в ДЗ 1
2. Создал БД Тест
```
postgres=# create database test;
CREATE DATABASE
postgres=# \l
                                                 List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    | ICU Locale | Locale Provider |   Access privileges
-----------+----------+----------+-------------+-------------+------------+-----------------+-----------------------
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            | =c/postgres          +
           |          |          |             |             |            |                 | postgres=CTc/postgres
 test      | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |            | libc            |
(4 rows)

postgres=# \q
```
3. Запустил инициализацию таблиц pgbench в БД test
```
otus@otus-db-pg-vm-1:~$ sudo -iu postgres pgbench -i  test
dropping old tables...
NOTICE:  table "pgbench_accounts" does not exist, skipping
NOTICE:  table "pgbench_branches" does not exist, skipping
NOTICE:  table "pgbench_history" does not exist, skipping
NOTICE:  table "pgbench_tellers" does not exist, skipping
creating tables...
generating data (client-side)...
100000 of 100000 tuples (100%) done (elapsed 0.17 s, remaining 0.00 s)
vacuuming...
creating primary keys...
done in 0.47 s (drop tables 0.00 s, create tables 0.01 s, client-side generate 0.24 s, vacuum 0.04 s, primary keys 0.18 s).
```
4. Сначала тестирую по примеру Константина Курочкина из ДЗ 3.
Запустил ограниченный по времени (1 минут) тест в 2 потока с имитацией 50 сеансов с выводом отчета о прогрессе каждые 10 сек
```
$ sudo -iu postgres pgbench -c 50 -j 2 -P 10 -T 60 test
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
progress: 10.0 s, 526.1 tps, lat 94.068 ms stddev 80.604, 0 failed
progress: 20.0 s, 585.8 tps, lat 85.356 ms stddev 69.263, 0 failed
progress: 30.0 s, 466.8 tps, lat 107.043 ms stddev 106.587, 0 failed
progress: 40.0 s, 531.2 tps, lat 94.187 ms stddev 74.245, 0 failed
progress: 50.0 s, 443.0 tps, lat 112.301 ms stddev 86.705, 0 failed
progress: 60.0 s, 337.9 tps, lat 148.337 ms stddev 144.078, 0 failed
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 50
number of threads: 2
maximum number of tries: 1
duration: 60 s
number of transactions actually processed: 28958
number of failed transactions: 0 (0.000%)
latency average = 103.589 ms
latency stddev = 94.438 ms
initial connection time = 52.758 ms
tps = 482.286055 (without initial connection time)
```
Запускал этот тест несколько раз, каждый раз разные значения. Tps (как я правильно понял это "транзакций в секунду") прыгали от 100 до 600

5. Затем запустил тест из лекции
```
$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 2.019 ms
latency stddev = 1.273 ms
initial connection time = 2.746 ms
tps = 495.098525 (without initial connection time)
```
Ниже приведу еще подряд сделанные тесты
```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 3.352 ms
latency stddev = 2.557 ms
initial connection time = 2.484 ms
tps = 298.261731 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 1.881 ms
latency stddev = 1.899 ms
initial connection time = 2.727 ms
tps = 531.451287 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 5.695 ms
latency stddev = 3.392 ms
initial connection time = 2.207 ms
tps = 175.567962 (without initial connection time)
```
Каждый раз tps разное)) 

6. Смотрю настройки по-умолчанию
![2023-05-16_12-01-59](https://github.com/sfedorovceavtru/otus_pg2/assets/122378097/2da550e2-38f7-417f-a666-a647d0eb858c)
7. Смотрю версию PostgreSQL на всякий случай
```
PostgreSQL 15.2 (Ubuntu 15.2-1.pgdg22.04+1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 11.3.0-1ubuntu1~22.04) 11.3.0, 64-bit
```
8. В https://pgtune.leopard.in.ua/ получил рекомендуемые значения
![2023-05-16_12-05-44](https://github.com/sfedorovceavtru/otus_pg2/assets/122378097/d724b0db-4e71-4390-817e-a2cceb503d2e)
9. Применил их
![2023-05-16_12-22-55](https://github.com/sfedorovceavtru/otus_pg2/assets/122378097/b978f03a-6e50-443d-af26-19dd1a2a5734)
10. Рестартанул кластер
```
$ sudo systemctl restart postgresql@15-main
$ pg_lsclusters
Ver Cluster Port Status Owner    Data directory    Log file
15  main    5432 online postgres /mnt/data/15/main /var/log/postgresql/postgresql-15-main.log
```
11. Выполнил первый тест
```
$ sudo -iu postgres pgbench -c 50 -j 2 -P 10 -T 60 test
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
progress: 10.0 s, 377.6 tps, lat 130.256 ms stddev 136.985, 0 failed
progress: 20.0 s, 398.8 tps, lat 125.372 ms stddev 110.196, 0 failed
progress: 30.0 s, 402.4 tps, lat 124.026 ms stddev 100.106, 0 failed
progress: 40.0 s, 364.1 tps, lat 138.231 ms stddev 136.977, 0 failed
progress: 50.0 s, 543.7 tps, lat 91.431 ms stddev 69.930, 0 failed
progress: 60.0 s, 425.6 tps, lat 117.889 ms stddev 103.056, 0 failed
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 50
number of threads: 2
maximum number of tries: 1
duration: 60 s
number of transactions actually processed: 25172
number of failed transactions: 0 (0.000%)
latency average = 119.146 ms
latency stddev = 110.289 ms
initial connection time = 68.169 ms
tps = 419.275172 (without initial connection time)
```
Провел мнодество тестов, результаты хуже,чем до применения настроек))
12. Провел тест из лекции
```
$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 3.218 ms
latency stddev = 2.638 ms
initial connection time = 3.113 ms
tps = 310.591802 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 2.480 ms
latency stddev = 1.596 ms
initial connection time = 3.188 ms
tps = 402.943096 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 1.693 ms
latency stddev = 0.961 ms
initial connection time = 2.271 ms
tps = 590.353622 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 2.671 ms
latency stddev = 2.634 ms
initial connection time = 2.343 ms
tps = 374.282314 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 2.119 ms
latency stddev = 1.890 ms
initial connection time = 2.337 ms
tps = 471.537968 (without initial connection time)
```

Тут тоже разброс большой))
Но прослеживается, что до применения рекомендуемых значений, производительность была выше

13. Ребутнул еще раз кластер
```
$ sudo -iu postgres pgbench -c 50 -j 2 -P 10 -T 60 test
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
progress: 10.0 s, 434.1 tps, lat 113.353 ms stddev 113.102, 0 failed
progress: 20.0 s, 578.5 tps, lat 86.087 ms stddev 65.479, 0 failed
progress: 30.0 s, 547.3 tps, lat 90.615 ms stddev 69.532, 0 failed
progress: 40.0 s, 362.3 tps, lat 139.732 ms stddev 131.845, 0 failed
progress: 50.0 s, 602.4 tps, lat 83.004 ms stddev 60.470, 0 failed
progress: 60.0 s, 530.8 tps, lat 92.441 ms stddev 71.180, 0 failed
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 50
number of threads: 2
maximum number of tries: 1
duration: 60 s
number of transactions actually processed: 30604
number of failed transactions: 0 (0.000%)
latency average = 98.408 ms
latency stddev = 88.890 ms
initial connection time = 75.842 ms
tps = 506.022141 (without initial connection time)
```
Значения стали уже лучше

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 1.456 ms
latency stddev = 0.897 ms
initial connection time = 2.082 ms
tps = 686.426600 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 1.269 ms
latency stddev = 0.535 ms
initial connection time = 2.976 ms
tps = 787.463580 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 2.248 ms
latency stddev = 1.956 ms
initial connection time = 2.174 ms
tps = 444.630201 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 1.435 ms
latency stddev = 0.994 ms
initial connection time = 2.966 ms
tps = 696.592271 (without initial connection time)
```

```
otus@otus-db-pg-vm-1:~$ echo "select count(1) from pgbench_accounts;" | sudo -iu postgres pgbench -t 50 -P 1
pgbench (15.2 (Ubuntu 15.2-1.pgdg22.04+1))
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
maximum number of tries: 1
number of transactions per client: 50
number of transactions actually processed: 50/50
number of failed transactions: 0 (0.000%)
latency average = 1.310 ms
latency stddev = 0.549 ms
initial connection time = 2.228 ms
tps = 763.032597 (without initial connection time)
```
Тесты стали вроде бы лучше.
Евгений, можете подсказать, почему может быть так, что один и тот же тест выдает разные результаты?

PS. Я потом для эксперимента, установил настройки для SSD-диска
```
random_page_cost = 1.1
effective_io_concurrency = 200
```
Менял work_mem в большую и меньшую сторону. 
Разброс результатов одних и тех же тестов при одинаковых настройках настораживает. Может это какая-то проблема YC?
